<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flashcards B√≠blicos</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #121212; --text: #e0e0e0; --card-bg: #1e1e1e; --border: #333; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            padding: 15px; 
            color: var(--text); 
            padding-bottom: 50px; /* Espa√ßo para scroll no mobile */
        }

        .container { max-width: 1000px; margin: 0 auto; }
        
        h1 { text-align: center; color: #fff; margin-bottom: 20px; font-weight: 300; font-size: 1.8rem; }
        
        /* GRID DE LIVROS RESPONSIVA */
        .book-grid {
            display: grid;
            /* Mobile: min 55px (5 colunas), Tablet/PC: min 70px */
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); 
            gap: 8px;
            margin-bottom: 30px;
        }

        .book-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px; /* Leg√≠vel no mobile */
            color: rgba(255,255,255,0.95);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        .book-btn:active { transform: scale(0.95); }

        /* CORES DAS CATEGORIAS */
        .cat-law, .cat-gospels { background-color: #3b78e7; }
        .cat-history, .cat-history-nt { background-color: #d35400; }
        .cat-poetry, .cat-general { background-color: #27ae60; }
        .cat-prophets, .cat-apoc { background-color: #c0392b; }
        .cat-paul { background-color: #f1c40f; color: #121212; }

        /* LOADING */
        .loading { 
            text-align: center; color: #aaa; display: none; margin-top: 40px; 
            font-size: 1.2rem; padding: 20px;
        }

        /* GAME AREA */
        #game-area, #review-area { display: none; animation: fadeIn 0.4s; }

        .stats-bar {
            display: flex; justify-content: space-between;
            background: #2c2c2c; padding: 15px; border-radius: 12px;
            margin-bottom: 20px; font-size: 0.9em; border: 1px solid var(--border);
        }

        .flashcard {
            background: var(--card-bg); border: 1px solid var(--border);
            padding: 25px; margin: 20px 0; border-radius: 16px;
            text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .verse-text { 
            font-size: 1.3rem; line-height: 1.5; display: block; 
            margin-bottom: 15px; color: #fff; 
        }
        .verse-ref { color: #888; font-style: italic; font-size: 0.9rem; margin-top: 10px; display: block;}

        .feedback-msg { 
            text-align: center; font-weight: bold; font-size: 1.1em; 
            min-height: 30px; margin: 10px 0; padding: 10px; border-radius: 8px;
        }

        /* OP√á√ïES RESPONSIVAS */
        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* Mobile: 1 coluna (lista vertical) */
            gap: 12px; 
        }

        .option-btn {
            background: #2c2c2c; border: 1px solid var(--border); color: #e0e0e0;
            padding: 18px; border-radius: 12px; text-align: left; cursor: pointer;
            font-size: 1rem; line-height: 1.4; touch-action: manipulation; /* Melhora toque no mobile */
        }
        
        .correct { background-color: #1b5e20 !important; border-color: #2e7d32 !important; color: white !important; }
        .wrong { background-color: #b71c1c !important; border-color: #c62828 !important; color: white !important; }

        /* REVIEW AREA */
        .review-list { list-style: none; padding: 0; max-height: 60vh; overflow-y: auto; }
        .review-item { 
            padding: 15px; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; font-size: 0.95em; 
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }

        /* BOT√ïES DE A√á√ÉO */
        .action-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;}
        button.action-btn {
            background: transparent; border: 1px solid #666; color: #ccc;
            padding: 12px 24px; border-radius: 50px; cursor: pointer; font-size: 0.9rem;
            flex: 1; min-width: 140px; max-width: 250px;
        }
        button.action-btn:active { background: rgba(255,255,255,0.1); }

        /* MEDIA QUERIES (Tablets e Desktop) */
        @media (min-width: 768px) {
            .book-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
            .book-btn { font-size: 18px; border-radius: 16px; }
            .options-grid { grid-template-columns: repeat(2, 1fr); } /* 2 colunas no PC/Tablet */
            .verse-text { font-size: 1.6rem; }
            .container { padding: 30px; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1 id="main-title">Flashcards B√≠blicos</h1>

    <!-- TELA DE SELE√á√ÉO -->
    <div id="setup-area">
        <div id="loading" class="loading">
            Carregando arquivos...<br>
            <small style="font-size:0.8em; color: #666">Lendo 'Subt√≠tulos.xlsx' e 'Vers√≠culos.xlsx'</small>
        </div>
        
        <div id="grid-container">
            <p style="text-align:center; color:#888; margin-bottom:20px;">Toque em um livro para come√ßar:</p>
            <div id="book-grid" class="book-grid"></div>
        </div>
    </div>

    <!-- TELA DO JOGO -->
    <div id="game-area">
        <div class="stats-bar">
            <span>üìñ <span id="current-book-name">...</span></span>
            <span>Faltam: <span id="remaining">0</span></span>
            <span style="color:#4caf50">‚úî <span id="score">0</span></span>
        </div>

        <div class="flashcard">
            <span class="verse-text" id="verse-text">...</span>
            <span class="verse-ref" id="verse-ref">Cap:Ver</span>
        </div>

        <div id="feedback" class="feedback-msg"></div>

        <div id="options-container" class="options-grid"></div>

        <div class="action-container">
            <button class="action-btn" onclick="toggleReviewMode()">Ver Estrutura</button>
            <button class="action-btn" onclick="resetGame()">Outro Livro</button>
        </div>
    </div>

    <!-- TELA DE REVIS√ÉO -->
    <div id="review-area">
        <h2>Estrutura do Livro</h2>
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="action-btn" onclick="toggleReviewMode()">Voltar ao Jogo</button>
        </div>
        <ul id="review-list" class="review-list"></ul>
    </div>
</div>

<script>
    // --- CORRE√á√ÉO DOS NOMES EXATOS ---
    // Devem ser id√™nticos aos do GitHub (respeitando mai√∫sculas e acentos)
    const ARQUIVO_BIBLIA = 'Vers√≠culos.xlsx'; 
    const ARQUIVO_SUBTITULOS = 'Subt√≠tulos.xlsx';

    // Lista de livros
    const bibleBooks = [
        { abbr: 'Gn', name: 'G√™nesis', cat: 'cat-law' }, { abbr: '√äx', name: '√äxodo', cat: 'cat-law' },
        { abbr: 'Lv', name: 'Lev√≠tico', cat: 'cat-law' }, { abbr: 'Nm', name: 'N√∫meros', cat: 'cat-law' },
        { abbr: 'Dt', name: 'Deuteron√¥mio', cat: 'cat-law' }, { abbr: 'Js', name: 'Josu√©', cat: 'cat-history' },
        { abbr: 'Jz', name: 'Ju√≠zes', cat: 'cat-history' }, { abbr: 'Rt', name: 'Rute', cat: 'cat-history' },
        { abbr: '1Sm', name: '1 Samuel', cat: 'cat-history' }, { abbr: '2Sm', name: '2 Samuel', cat: 'cat-history' },
        { abbr: '1Rs', name: '1 Reis', cat: 'cat-history' }, { abbr: '2Rs', name: '2 Reis', cat: 'cat-history' },
        { abbr: '1Cr', name: '1 Cr√¥nicas', cat: 'cat-history' }, { abbr: '2Cr', name: '2 Cr√¥nicas', cat: 'cat-history' },
        { abbr: 'Ed', name: 'Esdras', cat: 'cat-history' }, { abbr: 'Ne', name: 'Neemias', cat: 'cat-history' },
        { abbr: 'Et', name: 'Ester', cat: 'cat-history' }, { abbr: 'J√≥', name: 'J√≥', cat: 'cat-poetry' },
        { abbr: 'Sl', name: 'Salmos', cat: 'cat-poetry' }, { abbr: 'Pv', name: 'Prov√©rbios', cat: 'cat-poetry' },
        { abbr: 'Ec', name: 'Eclesiastes', cat: 'cat-poetry' }, { abbr: 'Ct', name: 'Cantares', cat: 'cat-poetry' },
        { abbr: 'Is', name: 'Isa√≠as', cat: 'cat-prophets' }, { abbr: 'Jr', name: 'Jeremias', cat: 'cat-prophets' },
        { abbr: 'Lm', name: 'Lamenta√ß√µes', cat: 'cat-prophets' }, { abbr: 'Ez', name: 'Ezequiel', cat: 'cat-prophets' },
        { abbr: 'Dn', name: 'Daniel', cat: 'cat-prophets' }, { abbr: 'Os', name: 'Os√©ias', cat: 'cat-prophets' },
        { abbr: 'Jl', name: 'Joel', cat: 'cat-prophets' }, { abbr: 'Am', name: 'Am√≥s', cat: 'cat-prophets' },
        { abbr: 'Ob', name: 'Obadias', cat: 'cat-prophets' }, { abbr: 'Jn', name: 'Jonas', cat: 'cat-prophets' },
        { abbr: 'Mq', name: 'Miqu√©ias', cat: 'cat-prophets' }, { abbr: 'Na', name: 'Naum', cat: 'cat-prophets' },
        { abbr: 'Hc', name: 'Habacuque', cat: 'cat-prophets' }, { abbr: 'Sf', name: 'Sofonias', cat: 'cat-prophets' },
        { abbr: 'Ag', name: 'Ageu', cat: 'cat-prophets' }, { abbr: 'Zc', name: 'Zacarias', cat: 'cat-prophets' },
        { abbr: 'Ml', name: 'Malaquias', cat: 'cat-prophets' }, { abbr: 'Mt', name: 'Mateus', cat: 'cat-gospels' },
        { abbr: 'Mc', name: 'Marcos', cat: 'cat-gospels' }, { abbr: 'Lc', name: 'Lucas', cat: 'cat-gospels' },
        { abbr: 'Jo', name: 'Jo√£o', cat: 'cat-gospels' }, { abbr: 'At', name: 'Atos', cat: 'cat-history-nt' },
        { abbr: 'Rm', name: 'Romanos', cat: 'cat-paul' }, { abbr: '1Co', name: '1 Cor√≠ntios', cat: 'cat-paul' },
        { abbr: '2Co', name: '2 Cor√≠ntios', cat: 'cat-paul' }, { abbr: 'Gl', name: 'G√°latas', cat: 'cat-paul' },
        { abbr: 'Ef', name: 'Ef√©sios', cat: 'cat-paul' }, { abbr: 'Fp', name: 'Filipenses', cat: 'cat-paul' },
        { abbr: 'Cl', name: 'Colossenses', cat: 'cat-paul' }, { abbr: '1Ts', name: '1 Tessalonicenses', cat: 'cat-paul' },
        { abbr: '2Ts', name: '2 Tessalonicenses', cat: 'cat-paul' }, { abbr: '1Tm', name: '1 Tim√≥teo', cat: 'cat-paul' },
        { abbr: '2Tm', name: '2 Tim√≥teo', cat: 'cat-paul' }, { abbr: 'Tt', name: 'Tito', cat: 'cat-paul' },
        { abbr: 'Fm', name: 'Filemom', cat: 'cat-paul' }, { abbr: 'Hb', name: 'Hebreus', cat: 'cat-general' },
        { abbr: 'Tg', name: 'Tiago', cat: 'cat-general' }, { abbr: '1Pe', name: '1 Pedro', cat: 'cat-general' },
        { abbr: '2Pe', name: '2 Pedro', cat: 'cat-general' }, { abbr: '1Jo', name: '1 Jo√£o', cat: 'cat-general' },
        { abbr: '2Jo', name: '2 Jo√£o', cat: 'cat-general' }, { abbr: '3Jo', name: '3 Jo√£o', cat: 'cat-general' },
        { abbr: 'Jd', name: 'Judas', cat: 'cat-general' }, { abbr: 'Ap', name: 'Apocalipse', cat: 'cat-apoc' }
    ];

    let dbVerses = [];
    let dbSubtitles = [];
    let gameQueue = [];
    let currentSubtitleList = [];
    let currentVerse = null;
    let sessionStats = { correct: 0, wrong: 0, total: 0 };
    let subtitlePerformance = {}; 

    window.onload = function() {
        const grid = document.getElementById('book-grid');
        bibleBooks.forEach(book => {
            const btn = document.createElement('button');
            btn.className = `book-btn ${book.cat}`;
            btn.innerText = book.abbr;
            btn.onclick = () => iniciarEstudo(book.name);
            grid.appendChild(btn);
        });
    }

    function cleanText(text) {
        if (!text) return "";
        let str = String(text);
        str = str.replace(/<[^>]*>/g, ''); 
        str = str.replace(/[<>\/]/g, '');
        return str.trim();
    }

    function normalize(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    }

    async function fetchExcel(filename) {
        // Encode URI Component garante que acentos na URL sejam lidos corretamente pelo navegador
        const safeUrl = encodeURI(filename);
        const response = await fetch(safeUrl);
        if (!response.ok) throw new Error(`N√£o foi poss√≠vel carregar: ${filename}`);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    }

    async function iniciarEstudo(bookName) {
        const loading = document.getElementById('loading');
        const gridContainer = document.getElementById('grid-container');
        
        loading.style.display = 'block';
        gridContainer.style.display = 'none';

        try {
            if (dbSubtitles.length === 0) dbSubtitles = await fetchExcel(ARQUIVO_SUBTITULOS);
            if (dbVerses.length === 0) dbVerses = await fetchExcel(ARQUIVO_BIBLIA);

            const targetBookData = dbSubtitles.filter(r => normalize(r['Livro']) === normalize(bookName));
            
            if (targetBookData.length === 0) throw new Error(`O livro "${bookName}" n√£o foi encontrado na planilha 'Subt√≠tulos.xlsx'.`);

            const bookCode = targetBookData[0]['C√≥d do livro'];
            const bookNameOfficial = targetBookData[0]['Livro'];

            const bookVersesRaw = dbVerses.filter(r => r['book_number'] == bookCode);

            if (bookVersesRaw.length === 0) throw new Error(`Vers√≠culos n√£o encontrados para o c√≥digo ${bookCode}.`);

            prepararLogica(bookNameOfficial, targetBookData, bookVersesRaw);

        } catch (error) {
            console.error(error);
            alert("Erro: " + error.message);
            loading.style.display = 'none';
            gridContainer.style.display = 'block';
        }
    }

    function prepararLogica(bookName, rawSubtitles, rawVerses) {
        currentSubtitleList = rawSubtitles.map(s => ({
            cap: parseInt(s['Cap√≠tulo']),
            ver: parseInt(s['Vers√≠culo']),
            text: cleanText(s['Subt√≠tulo'])
        })).sort((a, b) => (a.cap - b.cap) || (a.ver - b.ver));

        subtitlePerformance = {};
        currentSubtitleList.forEach(s => subtitlePerformance[s.text] = 'pending');

        gameQueue = [];

        rawVerses.forEach(v => {
            const vCap = parseInt(v['chapter']);
            const vVer = parseInt(v['verse']);
            const vText = cleanText(v['text']);
            let correctSub = null;
            
            for (let i = 0; i < currentSubtitleList.length; i++) {
                const sub = currentSubtitleList[i];
                if (sub.cap > vCap || (sub.cap === vCap && sub.ver > vVer)) break;
                correctSub = sub.text;
            }

            if (correctSub) {
                gameQueue.push({ text: vText, ref: `${vCap}:${vVer}`, answer: correctSub });
            }
        });

        if (gameQueue.length === 0) {
            alert("Erro: Nenhum vers√≠culo associado.");
            location.reload();
            return;
        }

        shuffleArray(gameQueue);
        sessionStats = { correct: 0, wrong: 0, total: gameQueue.length };

        document.getElementById('current-book-name').innerText = bookName;
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        loadCard();
    }

    function loadCard() {
        updateStats();
        const feedback = document.getElementById('feedback');
        feedback.innerText = "";
        feedback.className = "feedback-msg"; 
        
        if (gameQueue.length === 0) {
            alert("Livro finalizado!");
            toggleReviewMode();
            return;
        }

        currentVerse = gameQueue[0];
        document.getElementById('verse-text').innerText = currentVerse.text;
        document.getElementById('verse-ref').innerText = currentVerse.ref;
        generateOptions(currentVerse.answer);
    }

    function generateOptions(correctAnswer) {
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        container.style.pointerEvents = 'auto'; // Reabilita cliques

        let allOptions = [...new Set(currentSubtitleList.map(s => s.text))];
        let displayOptions;

        // L√≥gica: Se houver muitas op√ß√µes, pega a correta + 3 erradas
        // Em telas pequenas, muitas op√ß√µes poluem
        if (allOptions.length > 6) {
            let wrong = allOptions.filter(o => o !== correctAnswer);
            shuffleArray(wrong);
            displayOptions = [correctAnswer, ...wrong.slice(0, 3)];
        } else {
            displayOptions = [...allOptions];
        }
        
        shuffleArray(displayOptions);

        displayOptions.forEach(optText => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.innerText = optText;
            btn.onclick = () => checkAnswer(btn, optText, correctAnswer);
            container.appendChild(btn);
        });
    }

    function checkAnswer(btn, selected, correct) {
        document.getElementById('options-container').style.pointerEvents = 'none'; // Bloqueia tudo
        const feedback = document.getElementById('feedback');

        if (selected === correct) {
            btn.classList.add('correct');
            feedback.innerText = "Correto!";
            feedback.style.color = "#4caf50";
            sessionStats.correct++;
            if (subtitlePerformance[correct] !== 'wrong') subtitlePerformance[correct] = 'correct';
            gameQueue.shift();
            setTimeout(loadCard, 1000);
        } else {
            btn.classList.add('wrong');
            feedback.innerText = `Resposta: ${correct}`;
            feedback.style.color = "#f44336";
            sessionStats.wrong++;
            subtitlePerformance[correct] = 'wrong';
            
            // Destaca correta
            document.querySelectorAll('.option-btn').forEach(b => {
                if(b.innerText === correct) b.classList.add('correct');
            });

            const retry = gameQueue.shift();
            gameQueue.push(retry);
            setTimeout(loadCard, 2500);
        }
    }

    function updateStats() {
        document.getElementById('remaining').innerText = gameQueue.length;
        document.getElementById('score').innerText = sessionStats.correct;
    }

    function toggleReviewMode() {
        const gameDiv = document.getElementById('game-area');
        const reviewDiv = document.getElementById('review-area');
        const list = document.getElementById('review-list');

        if (reviewDiv.style.display === 'block') {
            reviewDiv.style.display = 'none';
            gameDiv.style.display = 'block';
        } else {
            list.innerHTML = '';
            currentSubtitleList.forEach(sub => {
                const li = document.createElement('li');
                li.className = 'review-item';
                let color = '#555';
                if (subtitlePerformance[sub.text] === 'correct') color = '#2e7d32';
                if (subtitlePerformance[sub.text] === 'wrong') color = '#c62828';

                li.innerHTML = `<div class="dot" style="background-color: ${color}"></div><div><strong>${sub.cap}:${sub.ver}</strong> - ${sub.text}</div>`;
                list.appendChild(li);
            });
            gameDiv.style.display = 'none';
            reviewDiv.style.display = 'block';
        }
    }

    function resetGame() { location.reload(); }
    function shuffleArray(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
</script>
</body>
</html>
