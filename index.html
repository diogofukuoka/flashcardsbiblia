<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards B√≠blicos</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #202124; --text: #e8eaed; --card-bg: #303134; }
        
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .container { max-width: 1000px; margin: 0 auto; padding: 10px; }
        
        h1, h2 { text-align: center; color: #fff; margin-bottom: 20px; font-weight: 300; }
        
        /* GRID DE LIVROS */
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 30px;
        }

        .book-btn {
            aspect-ratio: 1; /* Deixa quadrado */
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .book-btn:hover { transform: scale(1.05); filter: brightness(1.2); z-index: 2; }
        .book-btn:active { transform: scale(0.95); }

        /* CORES DAS CATEGORIAS */
        .cat-law, .cat-gospels { background-color: #4285f4; } /* Azul */
        .cat-history, .cat-history-nt { background-color: #e67e22; } /* Laranja */
        .cat-poetry, .cat-general { background-color: #34a853; } /* Verde */
        .cat-prophets, .cat-apoc { background-color: #ea4335; } /* Vermelho/Rosa */
        .cat-paul { background-color: #fbbc04; color: #202124; } /* Amarelo (texto escuro) */

        /* LOADING */
        .loading { text-align: center; color: #9aa0a6; display: none; margin-top: 20px; font-style: italic; }

        /* GAME AREA */
        #game-area, #review-area { display: none; animation: fadeIn 0.4s; }

        .stats-bar {
            display: flex; justify-content: space-between;
            background: #3c4043; padding: 15px; border-radius: 8px;
            margin-bottom: 20px; font-size: 0.9em;
        }

        .flashcard {
            background: var(--card-bg); border: 1px solid #5f6368;
            padding: 30px; margin: 20px 0; border-radius: 12px;
            text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .verse-text { font-size: 1.3em; line-height: 1.6; display: block; margin-bottom: 15px; color: #fff; }
        .verse-ref { color: #9aa0a6; font-style: italic; }

        .feedback-msg { text-align: center; font-weight: bold; font-size: 1.1em; min-height: 25px; margin: 15px 0; }

        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; }
        
        .option-btn {
            background: #3c4043; border: 1px solid #5f6368; color: #e8eaed;
            padding: 15px; border-radius: 6px; text-align: left; cursor: pointer;
            transition: 0.2s;
        }
        .option-btn:hover { background: #5f6368; }
        
        .correct { background-color: #1e8e3e !important; border-color: #1e8e3e !important; color: white !important; }
        .wrong { background-color: #d93025 !important; border-color: #d93025 !important; color: white !important; }

        /* REVIEW */
        .review-list { list-style: none; padding: 0; max-height: 60vh; overflow-y: auto; }
        .review-item { padding: 10px; border-bottom: 1px solid #5f6368; display: flex; align-items: center; font-size: 0.9em; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }

        button.action-btn {
            background: transparent; border: 1px solid #9aa0a6; color: #9aa0a6;
            padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 20px;
        }
        button.action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1 id="main-title">Flashcards B√≠blicos</h1>

    <!-- TELA DE SELE√á√ÉO (GRID) -->
    <div id="setup-area">
        <p style="text-align:center; color:#9aa0a6; margin-bottom:20px;">Selecione um livro para estudar:</p>
        <div id="book-grid" class="book-grid">
            <!-- Bot√µes gerados via JS -->
        </div>
        <div id="loading" class="loading">Carregando B√≠blia... aguarde...</div>
    </div>

    <!-- TELA DO JOGO -->
    <div id="game-area">
        <div class="stats-bar">
            <span>üìñ <span id="current-book-name">Livro</span></span>
            <span>Restantes: <span id="remaining">0</span></span>
            <span>Acertos: <span id="score">0</span></span>
        </div>

        <div class="flashcard">
            <span class="verse-text" id="verse-text">...</span>
            <span class="verse-ref" id="verse-ref">Cap:Ver</span>
        </div>

        <div id="feedback" class="feedback-msg"></div>

        <div id="options-container" class="options-grid"></div>

        <div style="text-align: center;">
            <button class="action-btn" onclick="toggleReviewMode()">Ver Estrutura / Revisar</button>
            <button class="action-btn" onclick="resetGame()">Escolher Outro Livro</button>
        </div>
    </div>

    <!-- TELA DE REVIS√ÉO -->
    <div id="review-area">
        <h2>Estrutura do Livro</h2>
        <div style="text-align: center; margin-bottom: 15px;">
            <button class="action-btn" onclick="toggleReviewMode()">Voltar ao Jogo</button>
        </div>
        <ul id="review-list" class="review-list"></ul>
    </div>
</div>

<script>
    const ARQUIVO_BIBLIA = 'biblia.xlsx'; 
    const ARQUIVO_SUBTITULOS = 'subtitulos.xlsx';

    // Lista de livros para gerar a grade
    const bibleBooks = [
        // Pentateuco (Lei)
        { abbr: 'Gn', name: 'G√™nesis', cat: 'cat-law' },
        { abbr: '√äx', name: '√äxodo', cat: 'cat-law' },
        { abbr: 'Lv', name: 'Lev√≠tico', cat: 'cat-law' },
        { abbr: 'Nm', name: 'N√∫meros', cat: 'cat-law' },
        { abbr: 'Dt', name: 'Deuteron√¥mio', cat: 'cat-law' },
        // Hist√≥ricos AT
        { abbr: 'Js', name: 'Josu√©', cat: 'cat-history' },
        { abbr: 'Jz', name: 'Ju√≠zes', cat: 'cat-history' },
        { abbr: 'Rt', name: 'Rute', cat: 'cat-history' },
        { abbr: '1Sm', name: '1 Samuel', cat: 'cat-history' },
        { abbr: '2Sm', name: '2 Samuel', cat: 'cat-history' },
        { abbr: '1Rs', name: '1 Reis', cat: 'cat-history' },
        { abbr: '2Rs', name: '2 Reis', cat: 'cat-history' },
        { abbr: '1Cr', name: '1 Cr√¥nicas', cat: 'cat-history' },
        { abbr: '2Cr', name: '2 Cr√¥nicas', cat: 'cat-history' },
        { abbr: 'Ed', name: 'Esdras', cat: 'cat-history' },
        { abbr: 'Ne', name: 'Neemias', cat: 'cat-history' },
        { abbr: 'Et', name: 'Ester', cat: 'cat-history' },
        // Po√©ticos
        { abbr: 'J√≥', name: 'J√≥', cat: 'cat-poetry' },
        { abbr: 'Sl', name: 'Salmos', cat: 'cat-poetry' },
        { abbr: 'Pv', name: 'Prov√©rbios', cat: 'cat-poetry' },
        { abbr: 'Ec', name: 'Eclesiastes', cat: 'cat-poetry' },
        { abbr: 'Ct', name: 'Cantares', cat: 'cat-poetry' },
        // Profetas Maiores
        { abbr: 'Is', name: 'Isa√≠as', cat: 'cat-prophets' },
        { abbr: 'Jr', name: 'Jeremias', cat: 'cat-prophets' },
        { abbr: 'Lm', name: 'Lamenta√ß√µes', cat: 'cat-prophets' },
        { abbr: 'Ez', name: 'Ezequiel', cat: 'cat-prophets' },
        { abbr: 'Dn', name: 'Daniel', cat: 'cat-prophets' },
        // Profetas Menores
        { abbr: 'Os', name: 'Os√©ias', cat: 'cat-prophets' },
        { abbr: 'Jl', name: 'Joel', cat: 'cat-prophets' },
        { abbr: 'Am', name: 'Am√≥s', cat: 'cat-prophets' },
        { abbr: 'Ob', name: 'Obadias', cat: 'cat-prophets' },
        { abbr: 'Jn', name: 'Jonas', cat: 'cat-prophets' },
        { abbr: 'Mq', name: 'Miqu√©ias', cat: 'cat-prophets' },
        { abbr: 'Na', name: 'Naum', cat: 'cat-prophets' },
        { abbr: 'Hc', name: 'Habacuque', cat: 'cat-prophets' },
        { abbr: 'Sf', name: 'Sofonias', cat: 'cat-prophets' },
        { abbr: 'Ag', name: 'Ageu', cat: 'cat-prophets' },
        { abbr: 'Zc', name: 'Zacarias', cat: 'cat-prophets' },
        { abbr: 'Ml', name: 'Malaquias', cat: 'cat-prophets' },
        // Evangelhos
        { abbr: 'Mt', name: 'Mateus', cat: 'cat-gospels' },
        { abbr: 'Mc', name: 'Marcos', cat: 'cat-gospels' },
        { abbr: 'Lc', name: 'Lucas', cat: 'cat-gospels' },
        { abbr: 'Jo', name: 'Jo√£o', cat: 'cat-gospels' },
        // Hist√≥rico NT
        { abbr: 'At', name: 'Atos', cat: 'cat-history-nt' },
        // Cartas Paulo
        { abbr: 'Rm', name: 'Romanos', cat: 'cat-paul' },
        { abbr: '1Co', name: '1 Cor√≠ntios', cat: 'cat-paul' },
        { abbr: '2Co', name: '2 Cor√≠ntios', cat: 'cat-paul' },
        { abbr: 'Gl', name: 'G√°latas', cat: 'cat-paul' },
        { abbr: 'Ef', name: 'Ef√©sios', cat: 'cat-paul' },
        { abbr: 'Fp', name: 'Filipenses', cat: 'cat-paul' },
        { abbr: 'Cl', name: 'Colossenses', cat: 'cat-paul' },
        { abbr: '1Ts', name: '1 Tessalonicenses', cat: 'cat-paul' },
        { abbr: '2Ts', name: '2 Tessalonicenses', cat: 'cat-paul' },
        { abbr: '1Tm', name: '1 Tim√≥teo', cat: 'cat-paul' },
        { abbr: '2Tm', name: '2 Tim√≥teo', cat: 'cat-paul' },
        { abbr: 'Tt', name: 'Tito', cat: 'cat-paul' },
        { abbr: 'Fm', name: 'Filemom', cat: 'cat-paul' },
        // Cartas Gerais
        { abbr: 'Hb', name: 'Hebreus', cat: 'cat-general' },
        { abbr: 'Tg', name: 'Tiago', cat: 'cat-general' },
        { abbr: '1Pe', name: '1 Pedro', cat: 'cat-general' },
        { abbr: '2Pe', name: '2 Pedro', cat: 'cat-general' },
        { abbr: '1Jo', name: '1 Jo√£o', cat: 'cat-general' },
        { abbr: '2Jo', name: '2 Jo√£o', cat: 'cat-general' },
        { abbr: '3Jo', name: '3 Jo√£o', cat: 'cat-general' },
        { abbr: 'Jd', name: 'Judas', cat: 'cat-general' },
        // Prof√©tico NT
        { abbr: 'Ap', name: 'Apocalipse', cat: 'cat-apoc' }
    ];

    // Vari√°veis de Estado
    let dbVerses = [];
    let dbSubtitles = [];
    let gameQueue = [];
    let currentSubtitleList = [];
    let currentVerse = null;
    let sessionStats = { correct: 0, wrong: 0, total: 0 };
    let subtitlePerformance = {}; 

    // --- INICIALIZA√á√ÉO ---
    window.onload = function() {
        const grid = document.getElementById('book-grid');
        bibleBooks.forEach(book => {
            const btn = document.createElement('button');
            btn.className = `book-btn ${book.cat}`;
            btn.innerText = book.abbr;
            btn.title = book.name; // Tooltip com nome completo
            btn.onclick = () => iniciarEstudo(book.name);
            grid.appendChild(btn);
        });
    }

    // --- FUN√á√ïES UTILIT√ÅRIAS ---
    function cleanText(text) {
        if (!text) return "";
        let str = String(text);
        str = str.replace(/<[^>]*>/g, ''); 
        str = str.replace(/[<>\/]/g, '');
        return str.trim();
    }

    function normalize(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    }

    async function fetchExcel(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Arquivo n√£o encontrado: ${url}`);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    }

    // --- L√ìGICA DO JOGO ---
    async function iniciarEstudo(bookName) {
        const loading = document.getElementById('loading');
        const grid = document.getElementById('book-grid');
        
        loading.style.display = 'block';
        grid.style.opacity = '0.3'; // Desabilita visualmente
        grid.style.pointerEvents = 'none'; // Desabilita cliques

        try {
            if (dbSubtitles.length === 0) dbSubtitles = await fetchExcel(ARQUIVO_SUBTITULOS);
            if (dbVerses.length === 0) dbVerses = await fetchExcel(ARQUIVO_BIBLIA);

            // 1. Encontrar o ID e dados do Livro
            const targetBookData = dbSubtitles.filter(r => normalize(r['Livro']) === normalize(bookName));
            
            if (targetBookData.length === 0) {
                // Tenta buscar "1 Reis" se o usu√°rio clicou e o Excel tem "1Reis" ou algo assim
                // Mas o normalize deve resolver a maioria dos casos de acentua√ß√£o
                throw new Error(`Livro "${bookName}" n√£o encontrado na planilha de subt√≠tulos. Verifique a grafia no Excel.`);
            }

            const bookCode = targetBookData[0]['C√≥d do livro'];
            const bookNameOfficial = targetBookData[0]['Livro'];

            // 2. Filtrar Vers√≠culos
            const bookVersesRaw = dbVerses.filter(r => r['book_number'] == bookCode);

            if (bookVersesRaw.length === 0) throw new Error(`Vers√≠culos n√£o encontrados para o c√≥digo ${bookCode} (Livro: ${bookNameOfficial})`);

            prepararLogica(bookNameOfficial, targetBookData, bookVersesRaw);

        } catch (error) {
            console.error(error);
            alert("Erro: " + error.message);
            // Reabilita grade em caso de erro
            loading.style.display = 'none';
            grid.style.opacity = '1';
            grid.style.pointerEvents = 'auto';
        }
    }

    function prepararLogica(bookName, rawSubtitles, rawVerses) {
        // Ordenar subt√≠tulos
        currentSubtitleList = rawSubtitles.map(s => ({
            cap: parseInt(s['Cap√≠tulo']),
            ver: parseInt(s['Vers√≠culo']),
            text: cleanText(s['Subt√≠tulo']),
            fullText: s['Subt√≠tulo']
        })).sort((a, b) => (a.cap - b.cap) || (a.ver - b.ver));

        subtitlePerformance = {};
        currentSubtitleList.forEach(s => subtitlePerformance[s.text] = 'pending');

        gameQueue = [];

        // Algoritmo de mapeamento (Vers√≠culo -> Subt√≠tulo)
        rawVerses.forEach(v => {
            const vCap = parseInt(v['chapter']);
            const vVer = parseInt(v['verse']);
            const vText = cleanText(v['text']);

            let correctSub = null;
            // Busca o subt√≠tulo imediatamente anterior ou igual ao vers√≠culo atual
            for (let i = 0; i < currentSubtitleList.length; i++) {
                const sub = currentSubtitleList[i];
                if (sub.cap > vCap || (sub.cap === vCap && sub.ver > vVer)) break;
                correctSub = sub.text;
            }

            if (correctSub) {
                gameQueue.push({
                    text: vText,
                    ref: `${vCap}:${vVer}`, // Ref simplificada
                    answer: correctSub
                });
            }
        });

        if (gameQueue.length === 0) {
            alert("Erro de mapeamento: Nenhum vers√≠culo foi associado a um subt√≠tulo.");
            document.getElementById('loading').style.display = 'none';
            document.getElementById('book-grid').style.opacity = '1';
            document.getElementById('book-grid').style.pointerEvents = 'auto';
            return;
        }

        shuffleArray(gameQueue);
        
        sessionStats.total = gameQueue.length;
        sessionStats.correct = 0;
        sessionStats.wrong = 0;

        // Atualiza UI
        document.getElementById('current-book-name').innerText = bookName;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';

        loadCard();
    }

    function loadCard() {
        updateStats();
        const feedback = document.getElementById('feedback');
        feedback.innerText = "";
        
        if (gameQueue.length === 0) {
            alert("Parab√©ns! Voc√™ finalizou o livro.");
            toggleReviewMode();
            return;
        }

        currentVerse = gameQueue[0];
        document.getElementById('verse-text').innerText = currentVerse.text;
        document.getElementById('verse-ref').innerText = currentVerse.ref;

        generateOptions(currentVerse.answer);
    }

    function generateOptions(correctAnswer) {
        const container = document.getElementById('options-container');
        container.innerHTML = '';

        let allOptions = currentSubtitleList.map(s => s.text);
        allOptions = [...new Set(allOptions)]; // Remove duplicados

        // Seleciona op√ß√µes para mostrar (tentar mostrar todas, mas limitar se houver muitas para n√£o quebrar UI m√≥vel)
        // Se houver mais de 8 subt√≠tulos, vamos pegar a correta + 5 aleat√≥rias para n√£o poluir
        // Se o usu√°rio quiser "todas embaralhadas", use a l√≥gica abaixo comentada.
        
        let displayOptions;
        if (allOptions.length > 10) {
            // Modo resumido para livros grandes (Salmos tem centenas)
            let wrongOptions = allOptions.filter(o => o !== correctAnswer);
            shuffleArray(wrongOptions);
            displayOptions = [correctAnswer, ...wrongOptions.slice(0, 5)]; // Correta + 5 erradas
        } else {
            displayOptions = [...allOptions];
        }
        
        shuffleArray(displayOptions);

        displayOptions.forEach(optText => {
            const btn = document.createElement('div'); // Div agindo como bot√£o para melhor controle de layout
            btn.className = 'option-btn';
            btn.innerText = optText;
            btn.onclick = () => {
                if(btn.style.pointerEvents === 'none') return; // Evita clique duplo
                checkAnswer(btn, optText, correctAnswer);
            };
            container.appendChild(btn);
        });
    }

    function checkAnswer(btn, selected, correct) {
        // Bloqueia todos
        const allBtns = document.querySelectorAll('.option-btn');
        allBtns.forEach(b => b.style.pointerEvents = 'none');

        const feedback = document.getElementById('feedback');

        if (selected === correct) {
            btn.classList.add('correct');
            feedback.innerText = "Correto!";
            feedback.style.color = "#27ae60";
            sessionStats.correct++;

            if (subtitlePerformance[correct] !== 'wrong') subtitlePerformance[correct] = 'correct';

            gameQueue.shift();
            setTimeout(loadCard, 1000);
        } else {
            btn.classList.add('wrong');
            feedback.innerText = `Resposta: ${correct}`;
            feedback.style.color = "#d93025";
            sessionStats.wrong++;

            subtitlePerformance[correct] = 'wrong';

            // Mostra o correto
            allBtns.forEach(b => {
                if (b.innerText === correct) b.classList.add('correct');
            });

            // Reinsere no fim da fila
            const retryItem = gameQueue.shift();
            gameQueue.push(retryItem);

            setTimeout(loadCard, 2500);
        }
    }

    function updateStats() {
        document.getElementById('remaining').innerText = gameQueue.length;
        document.getElementById('score').innerText = sessionStats.correct;
    }

    function toggleReviewMode() {
        const gameDiv = document.getElementById('game-area');
        const reviewDiv = document.getElementById('review-area');
        const list = document.getElementById('review-list');

        if (reviewDiv.style.display === 'block') {
            reviewDiv.style.display = 'none';
            gameDiv.style.display = 'block';
        } else {
            list.innerHTML = '';
            currentSubtitleList.forEach(sub => {
                const li = document.createElement('li');
                li.className = 'review-item';
                
                let color = '#5f6368'; // Pendente
                if (subtitlePerformance[sub.text] === 'correct') color = '#1e8e3e';
                if (subtitlePerformance[sub.text] === 'wrong') color = '#d93025';

                li.innerHTML = `
                    <div class="dot" style="background-color: ${color}"></div>
                    <div><strong>${sub.cap}:${sub.ver}</strong> - ${sub.text}</div>
                `;
                list.appendChild(li);
            });

            gameDiv.style.display = 'none';
            reviewDiv.style.display = 'block';
        }
    }

    function resetGame() {
        location.reload(); // Maneira mais segura de limpar mem√≥ria e voltar ao menu
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
</script>

</body>
</html>
